<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>i18n-excel</title>
  <script lang="javascript" src="https://cdn.sheetjs.com/xlsx-0.18.10/package/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="./style.css" />
</head>

<body>
  <section>
    <input type="text" placeholder="Please enter the sheet name" onblur="onBlur(this)">
    <input type="file" onchange="importf(this)" />
    <div class="flex">
      <div>
        en: <button onclick="copyToClipBoard('en')">copy</button>
        <textarea id="en"></textarea>
      </div>
    
      <div>
        es: <button onclick="copyToClipBoard('es')">copy</button>
        <textarea id="es"></textarea>
      </div>
    
      <div>
        ko: <button onclick="copyToClipBoard('ko')">copy</button>
        <textarea id="ko"></textarea>
      </div>

      <div>
        ru: <button onclick="copyToClipBoard('ru')">copy</button>
        <textarea id="ru"></textarea>
      </div>
    
      <div>
        id: <button onclick="copyToClipBoard('id')">copy</button>
        <textarea id="id"></textarea>
      </div>

      <div>
        tw: <button onclick="copyToClipBoard('tw')">copy</button>
        <textarea id="tw"></textarea>
      </div>
    </div>
  </section>

  <script>
    let wb; //读取完成的数据
    let rABS = false; //是否将文件读取为二进制字符串
    let sheetName = 'Sheet1'; //默认读取的sheet名
    const langMap = {
      en: {},
      es: {},
      ko: {},
      ru: {},
      id: {},
      tw: {}
    };

    // copy
    function copyToClipBoard (id) {
      const content = document.getElementById(id);
      content.select();
      document.execCommand('copy');
      console.log("Copied!");
    }

    function onBlur(e){
      sheetName = e.value;
    }

    function importf (obj) {
      //导入
      if (!obj.files) {
        return;
      }
      let f = obj.files[0];
      let reader = new FileReader();
      reader.onload = function (e) {
        let data = e.target.result;
        if (rABS) {
          wb = XLSX.read(btoa(fixdata(data)), { type: "base64" });
        } else {
          wb = XLSX.read(data, { type: "binary" });
        }
        const list = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);

        list.forEach((item) => {
          Object.keys(langMap).forEach((lang) => {
            langMap[lang][item["key"]] = item[lang] || "";
          });
        });

        Object.keys(langMap).forEach((lang) => {
          document.getElementById(lang).innerHTML = JSON.stringify(
            langMap[lang]
          );
        });
      };
      if (rABS) {
        reader.readAsArrayBuffer(f);
      } else {
        reader.readAsBinaryString(f);
      }
    }

    function fixdata (data) {
      //文件流转BinaryString
      let o = "",
        l = 0,
        w = 10240;
      for (; l < data.byteLength / w; ++l)
        o += String.fromCharCode.apply(
          null,
          new Uint8Array(data.slice(l * w, l * w + w))
        );
      o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w)));
      return o;
    }
  </script>
</body>

</html>
